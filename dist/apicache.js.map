{"version":3,"sources":["../src/apicache.js"],"names":["url","require","MemoryCache","pkg","t","ms","second","minute","hour","day","week","month","instances","matches","a","b","doesntMatch","logDuration","d","prefix","str","toFixed","ApiCache","memCache","globalOptions","debug","defaultDuration","enabled","appendKey","jsonp","redisClient","headerBlacklist","statusCodes","include","exclude","events","undefined","headers","middlewareOptions","instance","index","timers","push","id","length","c","arr","filter","arg","debugEnv","process","env","DEBUG","split","indexOf","console","log","apply","shouldCacheResponse","request","response","toggle","opt","codes","statusCode","addIndexEntries","key","req","groupName","apicacheGroup","group","groups","unshift","all","filterBlacklistedHeaders","Object","keys","reduce","acc","header","createCacheObject","status","data","encoding","cacheResponse","value","duration","redis","expireCallback","expire","hset","JSON","stringify","err","add","setTimeout","clear","Math","min","accumulateContent","res","content","_apicache","Buffer","isBuffer","oldContent","alloc","concat","makeResponseCacheable","next","strDuration","write","writeHead","end","cacheable","forEach","name","assign","_headers","arguments","cacheObject","elapsed","Date","apicacheTimer","sendCachedResponse","getHeaders","version","type","syncOptions","i","options","localOptions","target","isAutomatic","clearTimeout","delete","del","resetIndex","getIndex","parseDuration","match","len","parseFloat","unit","replace","toLowerCase","getDuration","middleware","cache","middlewareToggle","find","bypass","originalUrl","parse","pathname","cached","getValue","hgetall","obj","newInstance","config","clone","module","exports"],"mappings":"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","file":"apicache.js","sourcesContent":["var url         = require('url')\nvar MemoryCache = require('./memory-cache')\nvar pkg         = require('../package.json')\n\nvar t           = {\n  ms:           1,\n  second:       1000,\n  minute:       60000,\n  hour:         3600000,\n  day:          3600000 * 24,\n  week:         3600000 * 24 * 7,\n  month:        3600000 * 24 * 30,\n}\n\nvar instances = []\n\nvar matches = function(a) {\n  return function(b) { return a === b }\n}\n\nvar doesntMatch = function(a) {\n  return function(b) { return !matches(a)(b) }\n}\n\nvar logDuration = function(d, prefix) {\n  var str = (d > 1000) ? ((d/1000).toFixed(2) + 'sec') : (d + 'ms')\n  return '\\x1b[33m- ' + (prefix ? prefix + ' ' : '') + str + '\\x1b[0m'\n}\n\nfunction ApiCache() {\n  var memCache = new MemoryCache\n\n  var globalOptions = {\n    debug:              false,\n    defaultDuration:    3600000,\n    enabled:            true,\n    appendKey:          [],\n    jsonp:              false,\n    redisClient:        false,\n    headerBlacklist:    [],\n    statusCodes: {\n      include: [],\n      exclude: [],\n    },\n    events: {\n      'expire': undefined\n    },\n    headers: {\n      // 'cache-control':  'no-cache' // example of header overwrite\n    }\n  }\n\n  var middlewareOptions = []\n  var instance = this\n  var index = null\n  var timers = {}\n\n  instances.push(this)\n  this.id = instances.length\n\n  function debug(a,b,c,d) {\n    var arr = (['\\x1b[36m[apicache]\\x1b[0m', a,b,c,d]).filter(function(arg) { return arg !== undefined })\n    var debugEnv = process.env.DEBUG && process.env.DEBUG.split(',').indexOf('apicache') !== -1\n\n    return (globalOptions.debug || debugEnv) && console.log.apply(null, arr)\n  }\n\n  function shouldCacheResponse(request, response, toggle) {\n    var opt = globalOptions\n    var codes = opt.statusCodes\n\n    if (!response) return false\n\n    if (toggle && !toggle(request, response)) {\n      return false\n    }\n\n    if (codes.exclude && codes.exclude.length && codes.exclude.indexOf(response.statusCode) !== -1) return false\n    if (codes.include && codes.include.length && codes.include.indexOf(response.statusCode) === -1) return false\n\n    return true\n  }\n\n  function addIndexEntries(key, req) {\n    var groupName = req.apicacheGroup\n\n    if (groupName) {\n      debug('group detected \"' + groupName + '\"')\n      var group = (index.groups[groupName] = index.groups[groupName] || [])\n      group.unshift(key)\n    }\n\n    index.all.unshift(key)\n  }\n\n  function filterBlacklistedHeaders(headers) {\n    return Object.keys(headers).filter(function (key) {\n      return globalOptions.headerBlacklist.indexOf(key) === -1;\n    }).reduce(function (acc, header) {\n        acc[header] = headers[header];\n        return acc;\n    }, {});\n  }\n\n  function createCacheObject(status, headers, data, encoding) {\n    return {\n      status: status,\n      headers: filterBlacklistedHeaders(headers),\n      data: data,\n      encoding: encoding\n    }\n  }\n\n  function cacheResponse(key, value, duration) {\n    var redis = globalOptions.redisClient\n    var expireCallback = globalOptions.events.expire\n\n    if (redis) {\n      try {\n        redis.hset(key, \"response\", JSON.stringify(value))\n        redis.hset(key, \"duration\", duration)\n        redis.expire(key, duration/1000, expireCallback)\n      } catch (err) {\n        debug('[apicache] error in redis.hset()')\n      }\n    } else {\n      memCache.add(key, value, duration, expireCallback)\n    }\n\n    // add automatic cache clearing from duration, includes max limit on setTimeout\n    timers[key] = setTimeout(function() { instance.clear(key, true) }, Math.min(duration, 2147483647))\n  }\n\n  function accumulateContent(res, content) {\n    if (content) {\n      if (typeof(content) == 'string') {\n        res._apicache.content = (res._apicache.content || '') + content;\n      } else if (Buffer.isBuffer(content)) {\n        var oldContent = res._apicache.content\n        if (!oldContent) {\n          oldContent = !Buffer.alloc ? new Buffer(0) : Buffer.alloc(0);\n        }\n        res._apicache.content = Buffer.concat([oldContent, content], oldContent.length + content.length);\n      } else {\n        res._apicache.content = content\n        // res._apicache.cacheable = false;\n      }\n    }\n  }\n\n  function makeResponseCacheable(req, res, next, key, duration, strDuration, toggle) {\n    // monkeypatch res.end to create cache object\n    res._apicache = {\n      write: res.write,\n      writeHead: res.writeHead,\n      end: res.end,\n      cacheable: true,\n      content: undefined\n    }\n\n    // append header overwrites if applicable\n    Object.keys(globalOptions.headers).forEach(function(name) {\n      res.header(name, globalOptions.headers[name])\n    })\n\n    res.writeHead = function() {\n      // add cache control headers\n      if (!globalOptions.headers['cache-control']) {\n        if(shouldCacheResponse(req, res, toggle)) {\n          res.header('cache-control', 'max-age=' + (duration / 1000).toFixed(0));\n        } else {\n          res.header('cache-control', 'no-cache, no-store, must-revalidate');\n        }\n      }\n\n      res._apicache.headers = Object.assign({}, res._headers)\n      return res._apicache.writeHead.apply(this, arguments)\n    }\n\n    // patch res.write\n    res.write = function(content) {\n      accumulateContent(res, content);\n      return res._apicache.write.apply(this, arguments);\n    }\n\n    // patch res.end\n    res.end = function(content, encoding) {\n      if (shouldCacheResponse(req, res, toggle)) {\n\n        accumulateContent(res, content);\n\n        if (res._apicache.cacheable && res._apicache.content) {\n          addIndexEntries(key, req)\n          var headers = res._apicache.headers || res._headers\n          var cacheObject = createCacheObject(res.statusCode, headers, res._apicache.content, encoding)\n          cacheResponse(key, cacheObject, duration)\n\n          // display log entry\n          var elapsed = new Date() - req.apicacheTimer\n          debug('adding cache entry for \"' + key + '\" @ ' + strDuration, logDuration(elapsed))\n        }\n      }\n\n      return res._apicache.end.apply(this, arguments);\n    }\n\n    next()\n  }\n\n\n  function sendCachedResponse(request, response, cacheObject, toggle) {\n    if (toggle && !toggle(request, response)) {\n      return false\n    }\n\n    var headers = (typeof response.getHeaders === 'function') ? response.getHeaders() : response._headers;\n\n    Object.assign(headers, filterBlacklistedHeaders(cacheObject.headers || {}), {\n      'apicache-store': globalOptions.redisClient ? 'redis' : 'memory',\n      'apicache-version': pkg.version\n    })\n\n    // unstringify buffers\n    var data = cacheObject.data\n    if (data && data.type === 'Buffer') {\n      data = new Buffer(data.data)\n    }\n\n    response.writeHead(cacheObject.status || 200, headers)\n\n    return response.end(data, cacheObject.encoding)\n  }\n\n  function syncOptions() {\n    for (var i in middlewareOptions) {\n      Object.assign(middlewareOptions[i].options, globalOptions, middlewareOptions[i].localOptions)\n    }\n  }\n\n  this.clear = function(target, isAutomatic) {\n    var group = index.groups[target]\n    var redis = globalOptions.redisClient\n\n    if (group) {\n      debug('clearing group \"' + target + '\"')\n\n      group.forEach(function(key) {\n        debug('clearing cached entry for \"' + key + '\"')\n        clearTimeout(timers[key])\n        delete timers[key]\n        if (!globalOptions.redisClient) {\n          memCache.delete(key)\n        } else {\n          try {\n            redis.del(key)\n          } catch(err) {\n            console.log('[apicache] error in redis.del(\"' + key + '\")')\n          }\n        }\n        index.all = index.all.filter(doesntMatch(key))\n      })\n\n      delete index.groups[target]\n    } else if (target) {\n      debug('clearing ' + (isAutomatic ? 'expired' : 'cached') + ' entry for \"' + target + '\"')\n      clearTimeout(timers[target])\n      delete timers[target]\n      // clear actual cached entry\n      if (!redis) {\n        memCache.delete(target)\n      } else {\n        try {\n          redis.del(target)\n        } catch(err) {\n          console.log('[apicache] error in redis.del(\"' + target + '\")')\n        }\n      }\n\n      // remove from global index\n      index.all = index.all.filter(doesntMatch(target))\n\n      // remove target from each group that it may exist in\n      Object.keys(index.groups).forEach(function(groupName) {\n        index.groups[groupName] = index.groups[groupName].filter(doesntMatch(target))\n\n        // delete group if now empty\n        if (!index.groups[groupName].length) {\n          delete index.groups[groupName]\n        }\n      })\n    } else {\n      debug('clearing entire index')\n\n      if (!redis) {\n        memCache.clear()\n      } else {\n        // clear redis keys one by one from internal index to prevent clearing non-apicache entries\n        index.all.forEach(function(key) {\n          clearTimeout(timers[key])\n          delete timers[key]\n          try {\n            redis.del(key)\n          } catch(err) {\n            console.log('[apicache] error in redis.del(\"' + key + '\")')\n          }\n        })\n      }\n      this.resetIndex()\n    }\n\n    return this.getIndex()\n  }\n\n  function parseDuration(duration, defaultDuration) {\n    if (typeof duration === 'number') return duration\n\n    if (typeof duration === 'string') {\n      var split = duration.match(/^([\\d\\.,]+)\\s?(\\w+)$/)\n\n      if (split.length === 3) {\n        var len = parseFloat(split[1])\n        var unit = split[2].replace(/s$/i,'').toLowerCase()\n        if (unit === 'm') {\n          unit = 'ms'\n        }\n\n        return (len || 1) * (t[unit] || 0)\n      }\n    }\n\n    return defaultDuration\n  }\n\n  this.getDuration = function(duration) {\n    return parseDuration(duration, globalOptions.defaultDuration)\n  }\n\n  this.getIndex = function(group) {\n    if (group) {\n      return index.groups[group]\n    } else {\n      return index\n    }\n  }\n\n  this.middleware = function cache(strDuration, middlewareToggle, localOptions) {\n    var duration = instance.getDuration(strDuration)\n    var opt = {}\n\n    middlewareOptions.push({\n      options: opt\n    })\n\n    var options = function (localOptions) {\n      if (localOptions) {\n        middlewareOptions.find(function (middleware) {\n          return middleware.options === opt\n        }).localOptions = localOptions\n      }\n\n      syncOptions()\n\n      return opt\n    }\n\n    options(localOptions)\n\n    var cache = function(req, res, next) {\n      function bypass() {\n        debug('bypass detected, skipping cache.')\n        return next()\n      }\n\n      // initial bypass chances\n      if (!opt.enabled) return bypass()\n      if (req.headers['x-apicache-bypass'] || req.headers['x-apicache-force-fetch']) return bypass()\n\n      // REMOVED IN 0.11.1 TO CORRECT MIDDLEWARE TOGGLE EXECUTE ORDER\n      // if (typeof middlewareToggle === 'function') {\n      //   if (!middlewareToggle(req, res)) return bypass()\n      // } else if (middlewareToggle !== undefined && !middlewareToggle) {\n      //   return bypass()\n      // }\n\n      // embed timer\n      req.apicacheTimer = new Date()\n\n      // In Express 4.x the url is ambigious based on where a router is mounted.  originalUrl will give the full Url\n      var key = req.originalUrl || req.url\n\n      // Remove querystring from key if jsonp option is enabled\n      if (opt.jsonp) {\n        key = url.parse(key).pathname\n      }\n\n      // add appendKey (either custom function or response path)\n      if (typeof opt.appendKey === 'function') {\n        key += '$$appendKey=' + opt.appendKey(req, res)\n      } else if (opt.appendKey.length > 0) {\n        var appendKey = req\n\n        for (var i = 0; i < opt.appendKey.length; i++) {\n          appendKey = appendKey[opt.appendKey[i]]\n        }\n        key += '$$appendKey=' + appendKey\n      }\n\n      // attempt cache hit\n      var redis = opt.redisClient\n      var cached = !redis ? memCache.getValue(key) : null\n\n      // send if cache hit from memory-cache\n      if (cached) {\n        var elapsed = new Date() - req.apicacheTimer\n        debug('sending cached (memory-cache) version of', key, logDuration(elapsed))\n\n        return sendCachedResponse(req, res, cached, middlewareToggle)\n      }\n\n      // send if cache hit from redis\n      if (redis) {\n        try {\n          redis.hgetall(key, function (err, obj) {\n            if (!err && obj && obj.response) {\n              var elapsed = new Date() - req.apicacheTimer\n              debug('sending cached (redis) version of', key, logDuration(elapsed))\n\n              return sendCachedResponse(req, res, JSON.parse(obj.response), middlewareToggle)\n            } else {\n              return makeResponseCacheable(req, res, next, key, duration, strDuration, middlewareToggle)\n            }\n          })\n        } catch (err) {\n          // bypass redis on error\n          return makeResponseCacheable(req, res, next, key, duration, strDuration, middlewareToggle)\n        }\n      } else {\n        return makeResponseCacheable(req, res, next, key, duration, strDuration, middlewareToggle)\n      }\n    }\n\n    cache.options = options\n\n    return cache\n  }\n\n  this.options = function(options) {\n    if (options) {\n      Object.assign(globalOptions, options)\n      syncOptions()\n\n      if ('defaultDuration' in options) {\n        // Convert the default duration to a number in milliseconds (if needed)\n        globalOptions.defaultDuration = parseDuration(globalOptions.defaultDuration, 3600000);\n      }\n\n      return this\n    } else {\n      return globalOptions\n    }\n  }\n\n  this.resetIndex = function() {\n    index = {\n      all: [],\n      groups: {}\n    }\n  }\n\n  this.newInstance = function(config) {\n    var instance = new ApiCache()\n\n    if (config) {\n      instance.options(config)\n    }\n\n    return instance\n  }\n\n  this.clone = function() {\n    return this.newInstance(this.options())\n  }\n\n  // initialize index\n  this.resetIndex()\n}\n\nmodule.exports = new ApiCache()\n"]}